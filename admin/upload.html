<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCC Gallery Uploader</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial; background:#f6f2ea; margin:0; padding:24px;}
    .wrap{max-width:900px; margin:0 auto;}
    h1{margin:0 0 8px;}
    .card{background:#fff; border:1px solid #e5dccf; border-radius:14px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06);}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    select,input,button{font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid #d8cbb8;}
    button{cursor:pointer; background:#8a5a2b; color:#fff; border:none;}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .drop{margin-top:12px; padding:28px; border:2px dashed #c8b59b; border-radius:14px; background:#fffaf1; text-align:center;}
    .drop.drag{background:#fff2dc; border-color:#8a5a2b;}
    .list{margin-top:12px;}
    .item{display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid #eee; border-radius:12px; margin-top:8px; background:#fff;}
    .small{color:#6b5b47; font-size:13px;}
    .ok{color:green}
    .bad{color:#b00020}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CCC Drag-and-Drop Gallery Uploader</h1>
    <p class="small">Uploads to <b>assets/&lt;category&gt;/</b> and auto-updates <b>content/gallery/gallery.json</b>.</p>

    <div class="card">
      <div class="row">
        <label>
          Category:
          <select id="category">
            <option value="tumblers">tumblers</option>
            <option value="coasters">coasters</option>
            <option value="keychains">keychains</option>
            <option value="wallets">wallets</option>
            <option value="woodworks">woodworks</option>
          </select>
        </label>

        <label>
          Admin secret:
          <input id="secret" type="password" placeholder="(the one you set in Netlify env vars)" />
        </label>

        <button id="btnUpload" disabled>Upload</button>
        <button id="btnClear" type="button">Clear</button>
      </div>

      <div id="drop" class="drop">
        <b>Drop images here</b><br/>
        <span class="small">JPG / PNG recommended. You can drop multiple at once.</span><br/><br/>
        <input id="filePick" type="file" multiple accept="image/*" />
      </div>

      <div id="list" class="list"></div>
      <div id="status" class="small" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
  const drop = document.getElementById("drop");
  const list = document.getElementById("list");
  const statusEl = document.getElementById("status");
  const btnUpload = document.getElementById("btnUpload");
  const btnClear = document.getElementById("btnClear");
  const filePick = document.getElementById("filePick");
  const categoryEl = document.getElementById("category");
  const secretEl = document.getElementById("secret");

  let files = [];

  function render() {
    list.innerHTML = "";
    files.forEach((f, idx) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<div><b>${f.name}</b><div class="small">${Math.round(f.size/1024)} KB</div></div>
                       <button type="button" data-i="${idx}">Remove</button>`;
      div.querySelector("button").onclick = () => { files.splice(idx,1); render(); };
      list.appendChild(div);
    });
    btnUpload.disabled = files.length === 0;
  }

  function setStatus(msg, ok=true) {
    statusEl.className = "small " + (ok ? "ok" : "bad");
    statusEl.textContent = msg;
  }

  function addFiles(fileList) {
    for (const f of fileList) {
      if (!f.type.startsWith("image/")) continue;
      files.push(f);
    }
    render();
  }

  drop.addEventListener("dragover", (e) => {
    e.preventDefault();
    drop.classList.add("drag");
  });

  drop.addEventListener("dragleave", () => drop.classList.remove("drag"));

  drop.addEventListener("drop", (e) => {
    e.preventDefault();
    drop.classList.remove("drag");
    addFiles(e.dataTransfer.files);
  });

  filePick.addEventListener("change", () => addFiles(filePick.files));

  btnClear.addEventListener("click", () => {
    files = [];
    render();
    setStatus("");
  });

  async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  btnUpload.addEventListener("click", async () => {
    btnUpload.disabled = true;
    setStatus("Uploading…");

    try {
      const payload = {
        category: categoryEl.value,
        files: []
      };

      for (const f of files) {
        const b64 = await fileToBase64(f);
        payload.files.push({ name: f.name, base64: b64 });
      }

      const res = await fetch("/.netlify/functions/upload", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-secret": secretEl.value || ""
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Upload failed");

      setStatus(`✅ Uploaded ${data.added} image(s) and updated gallery.json`);
      files = [];
      render();
    } catch (err) {
      setStatus("❌ " + err.message, false);
      btnUpload.disabled = false;
    }
  });
</script>
</body>
</html>
